generator client {
  provider     = "prisma-client-js"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  user
  admin
  landlord
}

enum ReceiptStatus {
  pending
  approved
  rejected
}

enum FeedbackType {
  single
  multiple
}

enum FeedbackStatus {
  not_started
  in_progress
  completed
}

model User {
  id         String @id @default(uuid())
  first_name String
  last_name  String

  email      String  @unique
  password   String?
  address    String?
  avatar_url String?

  role           UserRole @default(user)
  points_balance Int      @default(0)
  created_at     DateTime @default(now())

  google_id String? @unique

  receipts         Receipt[]
  feedback_results FeedbackResult[]
}

model Receipt {
  id           String        @id @default(uuid())
  receipt_url  String
  status       ReceiptStatus @default(pending)
  points_value Int?

  created_at  DateTime  @default(now())
  approved_at DateTime?

  user_id String
  user    User   @relation(fields: [user_id], references: [id])

  feedback_results FeedbackResult[]
}

model Category {
  id          String  @id @default(uuid())
  name        String
  image_url   String
  description String?

  gift_cards GiftCard[]
}

model GiftCard {
  id         String   @id @default(uuid())
  name       String
  type       String?
  amount     Int
  gift_code  String?
  pdf_url    String?
  created_at DateTime @default(now())

  category_id String
  category    Category @relation(fields: [category_id], references: [id])
}

model FeedbackQuestion {
  id            String       @id @default(uuid())
  serial_number Int
  text          String
  type          FeedbackType
  options       String[]
  created_at    DateTime     @default(now())

  feedback_answers FeedbackAnswer[]
  feedback_result  FeedbackResult[]
}

model FeedbackResult {
  id                 String         @id @default(uuid())
  receipt_id         String
  user_id            String
  status             FeedbackStatus @default(not_started)
  total_questions    Int
  answered_questions Int            @default(0)
  earned_cents       Int            @default(0)

  current_question_id String?
  current_question    FeedbackQuestion? @relation(fields: [current_question_id], references: [id])

  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt
  completed_at DateTime?

  user    User             @relation(fields: [user_id], references: [id])
  receipt Receipt          @relation(fields: [receipt_id], references: [id])
  answers FeedbackAnswer[]

  @@unique([user_id, receipt_id])
}

model FeedbackAnswer {
  id                 String   @id @default(uuid())
  feedback_result_id String
  question_id        String
  answer             String[]
  created_at         DateTime @default(now())

  feedback_result FeedbackResult   @relation(fields: [feedback_result_id], references: [id])
  question        FeedbackQuestion @relation(fields: [question_id], references: [id])

  @@unique([feedback_result_id, question_id])
}
