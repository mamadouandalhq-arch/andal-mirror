generator client {
  provider     = "prisma-client-js"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  user
  admin
  landlord
}

enum ReceiptStatus {
  pending
  approved
  rejected
}

enum FeedbackType {
  single
  multiple
}

enum FeedbackStatus {
  inProgress
  completed
}

model User {
  id        String @id @default(uuid())
  firstName String
  lastName  String

  email     String  @unique
  password  String?
  address   String?
  avatarUrl String?

  role          UserRole @default(user)
  pointsBalance Int      @default(0)
  createdAt     DateTime @default(now())

  googleId String? @unique

  receipts             Receipt[]
  feedbackResults      FeedbackResult[]
  forgotPasswordTokens ForgotPasswordToken[]
}

model ForgotPasswordToken {
  id String @id @default(cuid())

  userId String @unique()
  user   User   @relation(fields: [userId], references: [id])

  token String

  createdAt DateTime @default(now())
  expiresAt DateTime
}

model Receipt {
  id         String        @id @default(uuid())
  receiptUrl String
  status     ReceiptStatus @default(pending)

  createdAt  DateTime  @default(now())
  approvedAt DateTime?

  comment String?

  userId String
  user   User   @relation(fields: [userId], references: [id])

  feedbackResult FeedbackResult?
}

model Category {
  id          String  @id @default(uuid())
  name        String
  imageUrl    String
  description String?

  giftCards GiftCard[]
}

model GiftCard {
  id        String   @id @default(uuid())
  name      String
  type      String?
  amount    Int
  giftCode  String?
  pdfUrl    String?
  createdAt DateTime @default(now())

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])
}

model FeedbackQuestion {
  id           String       @id @default(uuid())
  serialNumber Int          @unique()
  type         FeedbackType
  createdAt    DateTime     @default(now())

  options         FeedbackOption[]
  translations    FeedbackQuestionTranslation[]
  feedbackAnswers FeedbackAnswer[]
  feedbackResults FeedbackResult[]
}

model FeedbackQuestionTranslation {
  id        String   @id @default(uuid())
  language  String
  text      String
  createdAt DateTime @default(now())

  questionId String
  question   FeedbackQuestion @relation(fields: [questionId], references: [id])

  @@unique([questionId, language])
}

model FeedbackResult {
  id                String         @id @default(uuid())
  receiptId         String         @unique()
  userId            String
  status            FeedbackStatus @default(inProgress)
  totalQuestions    Int
  answeredQuestions Int            @default(0)
  pointsValue       Int            @default(0)

  currentQuestionId String?
  currentQuestion   FeedbackQuestion? @relation(fields: [currentQuestionId], references: [id])

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  user    User             @relation(fields: [userId], references: [id])
  receipt Receipt          @relation(fields: [receiptId], references: [id])
  answers FeedbackAnswer[]

  @@unique([userId, receiptId])
}

model FeedbackAnswer {
  id               String   @id @default(uuid())
  feedbackResultId String
  questionId       String
  answerKeys       String[]
  createdAt        DateTime @default(now())

  feedbackResult FeedbackResult   @relation(fields: [feedbackResultId], references: [id])
  question       FeedbackQuestion @relation(fields: [questionId], references: [id])

  @@unique([feedbackResultId, questionId])
}

model FeedbackOption {
  id        String   @id @default(uuid())
  key       String
  order     Int
  score     Int?
  createdAt DateTime @default(now())

  questionId String
  question   FeedbackQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  translations FeedbackOptionTranslation[]

  @@unique([questionId, key])
  @@unique([questionId, order])
}

model FeedbackOptionTranslation {
  id       String @id @default(uuid())
  language String
  label    String

  optionId String
  option   FeedbackOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@unique([optionId, language])
}
